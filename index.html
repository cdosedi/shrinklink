<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ShrinkLink</title>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"

    // ðŸ”‘ Replace with your Supabase details
    const SUPABASE_URL = "https://yktmezthrgowzjpqaosn.supabase.co"
    const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY"
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    // Detect repo name automatically
    const parts = window.location.pathname.split("/").filter(Boolean);
    const repoName = parts.length > 0 ? parts[0] : null;

    async function shortenUrl(){
      const longUrl = document.getElementById("longUrl").value
      if (!longUrl) {
        alert("Please enter a URL")
        return
      }

      const shortcode = Math.random().toString(36).substring(2, 7)
      const { error } = await supabase
        .from("links")
        .insert([{ shortcode: shortcode, url: longUrl }])

      if (error) {
        alert("Error saving link")
        console.error(error)
        return
      }

      const shortUrl = repoName
        ? `${window.location.origin}/${repoName}/${shortcode}`
        : `${window.location.origin}/${shortcode}`

      document.getElementById("result").innerHTML =
        `<p>âœ… Short URL: <a href="${shortUrl}" target="_blank">${shortUrl}</a></p>`
    }

    async function redirect(){
      // Remove repo name if it exists
      let path = repoName
        ? window.location.pathname.replace(`/${repoName}/`, "").trim()
        : window.location.pathname.replace("/", "").trim()

      if (!path) return;

      const { data, error } = await supabase
        .from("links")
        .select("url")
        .eq("shortcode", path)
        .single();

      if (data) {
        window.location.href = data.url
      } else {
        document.body.innerHTML = "<h1>404 - Short link not found</h1>"
      }
    }

    window.onload = redirect
    window.shortenUrl = shortenUrl
  </script>
</head>
<body>
  <h1>ðŸ”— ShrinkLink</h1>
  <input type="text" id="longUrl" placeholder="Paste your long URL here" size="50">
  <button onclick="shortenUrl()">Shorten</button>
  <div id="result"></div>
</body>
</html>
